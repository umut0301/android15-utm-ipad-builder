# 首次配置脚本使用指南

**作者**: Manus AI  
**最后更新**: 2026-01-28

---

## 1. 概述

`first-boot-setup.sh` 是一个一键式配置脚本，用于在您首次启动 Android 15 UTM 虚拟机后，自动完成所有必要的配置。

**核心功能**:
-   ✅ **固定 ADB 端口**: 永久将 ADB 端口固定在 5555，方便随时连接。
-   ✅ **安装 Termux**: 自动从 F-Droid 下载并安装 Termux 终端模拟器。
-   ✅ **系统优化**: 禁用 SELinux、启用 USB 调试持久化等。

**目标**: 让您的虚拟机真正实现"开箱即用"，无需手动配置。

---

## 2. 使用方法

### 前置要求

-   **虚拟机已启动**: 确保您的 Android 15 虚拟机正在运行。
-   **网络连接**: 确保您的电脑和 iPad 在同一个局域网内。
-   **ADB 工具**: 确保您的电脑已安装 ADB 工具。

### 操作步骤

1.  **获取脚本**: 从 GitHub 仓库下载或 `git pull` 更新。

2.  **打开终端**: 在您的 Windows/Mac/Linux 电脑上打开终端或 CMD。

3.  **运行脚本**: 

    ```bash
    # 进入脚本所在目录
    cd ~/android15-utm-ipad-builder/tools

    # 运行脚本（替换为您的虚拟机 IP 地址）
    bash first-boot-setup.sh 192.168.167.36
    ```

4.  **等待完成**: 脚本会自动执行所有配置，大约需要 2-3 分钟。

5.  **重启虚拟机**: 脚本会提示您是否立即重启，输入 `y` 即可。

---

## 3. 预期输出

```
╔════════════════════════════════════════════════════════════╗
║     Android 15 UTM 虚拟机首次配置脚本 v1.0                ║
║     一键完成所有配置，开箱即用                             ║
╚════════════════════════════════════════════════════════════╝

[INFO] 检查 ADB 工具...
[SUCCESS] ADB 工具已安装
[INFO] 连接到虚拟机: 192.168.167.36:5555
[SUCCESS] 已连接到虚拟机
[INFO] 获取 root 权限...
[SUCCESS] 已获取 root 权限（su）
[INFO] 固定 ADB 端口到 5555...
[SUCCESS] ADB 端口已固定到 5555（重启后生效）
[INFO] 下载并安装 Termux...
[SUCCESS] Termux 下载完成
[SUCCESS] Termux 安装完成
[INFO] 配置系统优化...
[SUCCESS] 系统优化完成

╔════════════════════════════════════════════════════════════╗
║                   🎉 配置完成！🎉                          ║
╚════════════════════════════════════════════════════════════╝

[SUCCESS] 所有配置已完成！

[INFO] 已完成的配置：
  ✅ ADB 端口固定在 5555
  ✅ Termux 已安装
  ✅ 系统优化已应用

[WARNING] 请重启虚拟机以使所有配置生效：
  adb reboot

[INFO] 重启后，您可以随时使用以下命令连接：
  adb connect 192.168.167.36:5555

是否立即重启虚拟机？(y/N): y
[INFO] 正在重启虚拟机...
[SUCCESS] 虚拟机正在重启...
[INFO] 请等待约 1-2 分钟后重新连接
```

---

## 4. 验证配置

虚拟机重启后，在您的电脑上执行：

```bash
# 验证 ADB 连接
adb connect 192.168.167.36:5555
adb devices

# 验证 Termux 安装
adb shell pm list packages | grep com.termux
```

**预期输出**:
```
List of devices attached
192.168.167.36:5555   device

package:com.termux
```

---

## 5. 故障排除

### 问题 1: 无法连接到虚拟机

**解决**:
-   确认 IP 地址是否正确。
-   确认电脑和 iPad 在同一个 Wi-Fi 网络。
-   在虚拟机中检查网络设置。
-   尝试手动连接：`adb connect <IP地址>:5555`

### 问题 2: 无法获取 root 权限

**解决**:
-   在虚拟机中打开 Magisk 应用。
-   进入"超级用户"选项卡，手动授予 Shell 的 root 权限。
-   如果还是不行，请在"开发者选项"中查找"Root 访问"并启用。

### 问题 3: Termux 下载失败

**解决**:
-   检查虚拟机的网络连接。
-   尝试在虚拟机的浏览器中访问 https://f-droid.org/。
-   如果 F-Droid 网站无法访问，请检查网络防火墙或 DNS 设置。

---

## 6. 脚本技术细节

### 自动连接

脚本会首先尝试 5555 端口，如果失败，会自动尝试 5554、5556、5558 等常见端口。

### root 权限获取

脚本会优先尝试 `adb root`，如果失败，会自动回退到 `su` 命令。

### 幂等性

脚本具有幂等性，可以重复运行：
-   如果 ADB 端口已固定，会跳过配置。
-   如果 Termux 已安装，会跳过安装。

### 依赖检查

脚本会自动检查本地是否安装了 ADB 工具，如果没有，会提示安装。

---

## 7. 总结

`first-boot-setup.sh` 是一个强大而简单的工具，可以为您节省大量的手动配置时间。

**只需一次运行，即可永久享受开箱即用的体验！** 🚀
