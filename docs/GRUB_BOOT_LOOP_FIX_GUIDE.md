# 🆘 紧急修复指南：解决 Grub 启动循环和存储扩展问题

**问题**: 虚拟机启动后陷入 Grub 菜单循环，并且无法在 UTM 中调整存储大小。
**状态**: 🔴 **严重** - 阻止虚拟机启动
**日期**: 2026-01-28

---

## 🎯 核心问题诊断

您遇到的 “Grub 菜单循环” 是一个关键线索。它表明 UTM 虚拟机的配置存在根本性错误。

> **核心原因**：Android for ARM64 架构**不应该使用 Grub** 来启动。它使用 UEFI 直接引导。如果您看到了 Grub 菜单，几乎可以肯定是 UTM 虚拟机的**架构设置错误**，它可能被错误地配置为了 `x86_64` 而不是 `ARM64`。

关于存储问题，UTM 的界面可能有些不直观。您**不能在导入后直接调整大小**，而是在导入创建的虚拟机配置中进行修改。

---

## ✅ 解决方案：三步修复法

请严格按照以下三个步骤操作，这将解决启动循环和存储扩展两个问题。

### 第一步：删除错误的虚拟机（重要！）

一个配置错误的虚拟机会缓存不正确的设置。我们必须从一个干净的状态开始。

1.  在 iPad 上打开 **UTM**。
2.  在虚拟机列表中，**长按** 名为 “LineageOS on arm64” 的虚拟机。
3.  在弹出的菜单中，选择 **“删除”**（Delete）。
4.  在确认对话框中，**同时勾选 “删除驱动器镜像”**（Delete Drive Images）以彻底清除所有相关文件。
5.  确认删除。

现在，您已经移除了损坏的虚拟机，可以重新开始了。

### 第二步：重新导入并正确配置

这次，我们将在导入后立即验证和修改配置。

1.  **重新导入**: 
    *   点击 UTM 右上角的 **“+”** 按钮，选择 **“导入”**。
    *   选择您之前传输的 `UTM-VM-lineage-23.0-*.zip` 文件。
    *   等待导入完成。您会再次看到 “LineageOS on arm64” 出现在列表中。

2.  **编辑配置（在启动前！）**: 
    *   **长按** 新导入的虚拟机，选择 **“编辑”**。

3.  **验证/修改系统架构（最关键的一步！）**: 
    *   进入左侧的 **“系统”** (System) 选项卡。
    *   **确保设置如下**：
        *   **架构 (Architecture)**: `ARM64 (aarch64)`
        *   **系统 (System)**: `QEMU ARM Virtual Machine (virt)`
    *   如果架构是 `x86_64` 或其他任何值，**必须**修改为 `ARM64 (aarch64)`。这就是导致 Grub 循环的根本原因。

### 第三步：正确扩展存储空间

在**同一个编辑界面**，现在我们来解决存储空间的问题。

1.  **进入驱动器设置**: 
    *   在左侧菜单中，选择 **“驱动器”** (Drives)。

2.  **找到主驱动器**: 
    *   您会看到一个列表，其中应该有一个名为 `disk-vda.img` 或类似名称的驱动器。它的大小应该是 **12 GB** 左右。

3.  **调整大小**: 
    *   **点击这个驱动器**。会弹出一个配置窗口。
    *   在这个窗口中，找到 **“大小 (MB)”** (Size (MB)) 或 **“大小 (GB)”** (Size (GB)) 字段。
    *   **在这里输入您想要的大小**。例如，要设置为 128GB，请输入 `128000` (如果单位是 MB) 或 `128` (如果单位是 GB)。
    *   **点击 “保存”**。

4.  **保存所有更改**: 
    *   返回虚拟机的编辑主界面，点击右上角的 **“保存”**。

---

## 🚀 启动并验证

现在，您已经完成了所有修复和配置。可以启动虚拟机了。

1.  **启动虚拟机**: 在 UTM 主界面，点击 “LineageOS on arm64” 启动。

2.  **观察正确的启动流程**: 
    *   您**不应该**再看到 Grub 菜单。
    *   您应该看到 **UEFI 启动界面**（可能是黑屏和一些白色文字，快速闪过）。
    *   紧接着，您应该看到 **LineageOS 的启动动画**（一个动态的线条图案）。
    -   首次启动会比较慢（3-5分钟），因为它正在扩展文件系统以填满您设置的 128GB 空间。

3.  **进入系统后验证存储**: 
    *   完成 Android 设置向导。
    *   进入 **“设置”** -> **“存储”**。
    *   检查 **“内部共享存储空间”** 的总容量。如果您设置了 128 GB，这里应该显示大约 115 GB 左右（因为系统本身占用了约 12 GB）。

---

## 🛠️ 故障排除

### 如果仍然无法启动怎么办？

-   **确认架构**: 再次重复第二步，确保架构绝对是 `ARM64 (aarch64)`。
-   **检查驱动器接口**: 在 “驱动器” 设置中，确保 `disk-vda.img` 的接口是 `VirtIO`。
-   **检查显示设置**: 确认 “显示” 选项卡中的显卡是 `virtio-gpu-gl-pci`。

### 为什么我之前不能输入大小？

UTM 的设计是，当您从模板（如我们的 `.zip` 文件）导入时，它会创建一个新的、独立的虚拟磁盘。您必须在虚拟机的**编辑模式**下，选择这个**新创建的磁盘**才能修改其大小。直接在文件列表或导入向导中是无法修改的。

---

## 总结

| 问题 | 根本原因 | 解决方案 |
|---|---|---|
| **Grub 启动循环** | UTM 虚拟机架构被错误设置为 `x86_64` | 删除虚拟机，重新导入，并在启动前将架构修正为 `ARM64 (aarch64)` |
| **无法扩展存储** | 在错误的界面尝试修改 | 在虚拟机的 “编辑” -> “驱动器” 菜单中，选择主磁盘并输入新的大小 |

请严格按照上述步骤操作。我相信这次一定能成功！如果还有问题，请随时告诉我。
