# UTM 虚拟机存储管理完整指南

**版本**: v2.0 (已修复)  
**日期**: 2026-01-27  
**适用于**: iPad Pro M1 + UTM + LineageOS 23.0

---

## ⚠️ 重要说明

### 存储配置的正确理解

**关键概念**:
- ✅ LineageOS 使用**动态分区**技术
- ✅ 存储大小由 **UTM 虚拟磁盘**决定，不是编译时设置
- ✅ Android 会**自动使用**所有可用空间
- ❌ **不需要**在编译时预设分区大小
- ❌ **不需要**修改 BoardConfig.mk

### 配置工具的作用

`configure-storage.sh` 脚本的作用是：
1. 帮助您选择合适的存储大小
2. 生成 UTM 导入时的配置指南
3. 提供存储空间使用建议

**不会**:
- 修改 LineageOS 编译配置
- 改变编译产物的大小
- 影响编译过程

---

## 🚀 快速开始

### 3 步完成配置

```bash
# 步骤 1: 运行配置向导
bash scripts/configure-storage.sh

# 步骤 2: 选择存储大小
# 推荐选择 128GB（选项 2）

# 步骤 3: 查看生成的配置指南
cat ~/android/utm_config/UTM_IMPORT_GUIDE_128GB.txt
```

---

## 📊 存储选项对比

| 选项 | 总容量 | 系统占用 | 可用空间 | 适用场景 | iPad 占用 |
|------|--------|----------|----------|----------|-----------|
| 64GB | 64GB | ~6GB | ~58GB | 轻度使用、测试 | ~65GB |
| **128GB** | **128GB** | **~8GB** | **~120GB** | **日常使用（推荐）** | **~130GB** |
| 256GB | 256GB | ~8GB | ~248GB | 重度使用、游戏 | ~260GB |

---

## 📱 UTM 导入指南

### 完整导入流程

#### 1. 编译 LineageOS（正常编译）

```bash
bash scripts/03-build-android.sh
```

**重要**: 编译过程不需要任何特殊配置，使用默认设置即可。

#### 2. 传输文件到 iPad

编译完成后，找到文件：
```
~/android/lineage/out/target/product/virtio_arm64/
└── UTM-VM-lineage-*.zip
```

#### 3. 在 iPad 上解压并导入

1. 打开 "文件" 应用
2. 找到 `UTM-VM-lineage-*.zip`
3. 长按文件 → "解压缩"
4. 得到 `.utm` 文件夹

#### 4. 导入到 UTM

1. 打开 UTM 应用
2. 点击右上角 "+" 按钮
3. 选择 "浏览"
4. 找到并选择 `.utm` 文件夹
5. 等待导入完成

#### 5. 配置虚拟机存储 ⚠️ **关键步骤**

1. 在 UTM 中，长按虚拟机
2. 选择 "编辑"
3. 进入 "驱动器" 设置
4. 找到主磁盘驱动器（通常是第一个）
5. 设置 "磁盘大小" 为您选择的大小（如 **128GB**）
6. 点击 "保存"

#### 6. 启动虚拟机

1. 点击虚拟机启动
2. 首次启动会进行初始化（约 2-5 分钟）
3. 等待进入 LineageOS 设置向导
4. 完成初始设置
5. 享受 Android 15！

---

## ❓ 常见问题

### Q1: 为什么不在编译时设置存储大小？

**A**: LineageOS 使用动态分区技术，会自动使用 UTM 虚拟磁盘的所有可用空间。

### Q2: 我可以在导入后修改存储大小吗？

**A**: 可以！在 UTM 中编辑虚拟机 → 驱动器设置 → 增加磁盘大小 → 重启虚拟机。

**注意**: 只能增大，不能缩小。

### Q3: 编译产物的大小是多少？

**A**: 约 2-3GB（压缩后的 ZIP 文件），与您选择的存储大小无关。

---

## 💡 最佳实践

1. **选择合适的存储大小**: 日常使用推荐 128GB
2. **留出足够的 iPad 空间**: 虚拟机大小 + 100GB ≤ iPad 可用空间
3. **定期备份**: 在 UTM 中导出虚拟机并保存到云存储
4. **监控存储使用**: Android 设置 → 存储 → 查看可用空间

---

**祝您使用愉快！** 🎉
